# DaemonSetでKubernetesノードの/etc/hostsにharbor.localを追加
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: harbor-host-alias
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: harbor-host-alias
  template:
    metadata:
      labels:
        name: harbor-host-alias
    spec:
      hostNetwork: true
      hostPID: true
      containers:
      - name: harbor-host-alias
        image: busybox
        command:
        - sh
        - -c
        - |
          # /etc/hostsにharbor.localエントリを追加
          if ! grep -q "harbor.local" /host-etc/hosts; then
            echo "192.168.122.100 harbor.local" >> /host-etc/hosts
            echo "Added harbor.local to /etc/hosts"
          else
            echo "harbor.local already exists in /etc/hosts"
          fi
          # 定期的にチェック
          while true; do
            if ! grep -q "harbor.local" /host-etc/hosts; then
              echo "192.168.122.100 harbor.local" >> /host-etc/hosts
              echo "Re-added harbor.local to /etc/hosts"
            fi
            sleep 300
          done
        volumeMounts:
        - name: host-etc
          mountPath: /host-etc
        securityContext:
          privileged: true
      volumes:
      - name: host-etc
        hostPath:
          path: /etc
      tolerations:
      - operator: Exists