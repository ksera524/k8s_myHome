# ArgoCD Application for Promtail (Grafana Cloud版)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: promtail
  namespace: argocd
  labels:
    app.kubernetes.io/name: promtail
    app.kubernetes.io/part-of: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  
  source:
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 6.16.6
    chart: promtail
    helm:
      releaseName: promtail
      valuesObject:
        # Grafana Cloudの接続設定
        config:
          clients:
            - url: https://logs-prod-030.grafana.net/loki/api/v1/push
              basic_auth:
                username: 1328813
                password_file: /etc/promtail/secrets/GRAFANA_CLOUD_LOKI_PASSWORD
          
          # ログポジション記録
          positions:
            filename: /run/promtail/positions.yaml
          
          # スクレイプ設定
          snippets:
            scrapeConfigs: |
              # Kubernetesポッドログ
              - job_name: kubernetes-pods
                kubernetes_sd_configs:
                  - role: pod
                pipeline_stages:
                  - cri: {}
                relabel_configs:
                  # namespace追加
                  - source_labels: [__meta_kubernetes_namespace]
                    target_label: namespace
                  # pod名追加
                  - source_labels: [__meta_kubernetes_pod_name]
                    target_label: pod
                  # container名追加
                  - source_labels: [__meta_kubernetes_pod_container_name]
                    target_label: container
                  # node名追加
                  - source_labels: [__meta_kubernetes_pod_node_name]
                    target_label: node
                  # app label追加
                  - source_labels: [__meta_kubernetes_pod_label_app]
                    target_label: app
                  - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
                    target_label: app_name
                  # ログパス設定
                  - replacement: /var/log/pods/*$1/*.log
                    separator: /
                    source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
                    target_label: __path__
        
        # External Secretからの認証情報マウント
        extraSecretMounts:
          - name: grafana-cloud-credentials
            mountPath: /etc/promtail/secrets
            secretName: grafana-cloud-credentials
            readOnly: true
        
        # リソース設定
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        
        # DaemonSet設定（全ノードで実行）
        daemonset:
          enabled: true
        
        # 全ノードで実行するための設定
        tolerations:
          - effect: NoSchedule
            operator: Exists
          - effect: NoExecute
            operator: Exists
        
        # セキュリティコンテキスト
        containerSecurityContext:
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
            add:
              - CHOWN
              - DAC_OVERRIDE
              - FOWNER
              - FSETID
              - KILL
              - SETGID
              - SETUID
              - SETPCAP
              - NET_BIND_SERVICE
              - NET_RAW
              - SYS_CHROOT
              - MKNOD
              - AUDIT_WRITE
              - SETFCAP
  
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  revisionHistoryLimit: 3
  
  # Health checks
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/replicas