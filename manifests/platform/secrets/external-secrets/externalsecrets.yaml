# Harbor用ExternalSecret設定
# Pulumi ESCからHarbor認証情報を自動取得
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-admin-secret
  namespace: harbor
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-admin-secret
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        # Harbor Core用パスワード（automation用）
        username: "admin"
        password: '{{ .harbor }}'
        # CI/CD用パスワード
        HARBOR_CI_PASSWORD: '{{ .harbor_ci }}'
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor
  - secretKey: harbor_ci
    remoteRef:
      key: harbor_ci

---
# Harbor CI用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-ci-secret
  namespace: harbor
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-ci-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-ci-secret
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        username: "ciuser"
        password: '{{ .harbor_ci }}'
  data:
  - secretKey: harbor_ci
    remoteRef:
      key: harbor_ci

---
# GitHub Actions用Harbor認証Secret (arc-systems namespace)
# skopeo対応版
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-auth-secret
  namespace: arc-systems
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: github-actions-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-auth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        HARBOR_USERNAME: "admin"
        HARBOR_PASSWORD: '{{ .harbor }}'
        HARBOR_URL: "192.168.122.100"
        HARBOR_PROJECT: "sandbox"
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor
---
# Cloudflared用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cloudflared-secret
  namespace: cloudflared
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: cloudflared-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: cloudflared
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        token: "{{ .cloudflared | default \"\" }}"
  data:
  - secretKey: cloudflared
    remoteRef:
      key: cloudflared

---
# GitHub Actions用ExternalSecret (arc-systems namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: github-auth-secret
  namespace: arc-systems
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: github-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: github-auth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        GITHUB_TOKEN: "{{ .github }}"
        GITHUB_USERNAME: "ksera524"
  data:
  - secretKey: github
    remoteRef:
      key: github

---
# Harbor Docker Registry Secret for ARC Controllers (arc-systems namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry-secret
  namespace: arc-systems
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-registry
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: v2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "192.168.122.100": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor

---
# Slack用ExternalSecret (sandbox namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: slack-secret
  namespace: sandbox
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: slack-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: slack
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        SLACK_BOT_TOKEN: "{{ .slack | default \"\" }}"
        token: "{{ .slack | default \"\" }}"
  data:
  - secretKey: slack
    remoteRef:
      key: slack
