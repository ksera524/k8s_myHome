# Harbor用ExternalSecret設定
# Pulumi ESCからHarbor認証情報を自動取得
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-admin-secret
  namespace: harbor
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-admin-secret
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        # Harbor Core用パスワード（automation用）
        username: "admin"
        password: '{{ .harbor }}'
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor

---
# GitHub Actions用Harbor認証Secret (arc-systems namespace)
# skopeo対応版
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-auth-secret
  namespace: arc-systems
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: github-actions-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-auth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        HARBOR_USERNAME: "admin"
        HARBOR_PASSWORD: '{{ .harbor }}'
        HARBOR_URL: "harbor.qroksera.com"
        HARBOR_PROJECT: "sandbox"
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor
---
# Cloudflared用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cloudflared-secret
  namespace: cloudflared
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: cloudflared-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: cloudflared
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        token: "{{ .cloudflared | default \"\" }}"
  data:
  - secretKey: cloudflared
    remoteRef:
      key: cloudflared

---
# Cloudflare DNS-01用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cloudflare-api-token
  namespace: cert-manager
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: cloudflare-dns-01
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: cloudflare-api-token
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        api-token: "{{ index . \"dns-01\" }}"
  data:
  - secretKey: dns-01
    remoteRef:
      key: dns-01

---
# Tailscale OAuth用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: tailscale-oauth
  namespace: tailscale
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: tailscale-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: operator-oauth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        client_id: "{{ .client_id }}"
        client_secret: "{{ .client_secret }}"
  data:
  - secretKey: client_id
    remoteRef:
      key: tailscale.client_id
  - secretKey: client_secret
    remoteRef:
      key: tailscale.client_secret

---
# GitHub Actions用ExternalSecret (arc-systems namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: github-auth-secret
  namespace: arc-systems
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: github-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: github-auth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        GITHUB_TOKEN: "{{ .github }}"
        GITHUB_USERNAME: "ksera524"
  data:
  - secretKey: github
    remoteRef:
      key: github

---
# ArgoCD用GHCRリポジトリSecret (argocd namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ghcr-nginx-charts-secret
  namespace: argocd
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: ghcr-repo
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: ghcr-nginx-charts
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
      data:
        name: ghcr-nginx-charts
        url: oci://ghcr.io/nginx/charts/nginx-gateway-fabric
        username: "ksera524"
        password: "{{ .ghcr }}"
        type: helm
        enableOCI: "true"
  data:
  - secretKey: ghcr
    remoteRef:
      key: ghcr

---
# ArgoCD用GitHubリポジトリ認証（Image Updater書き戻し用）
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: github-repo-secret
  namespace: argocd
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: github-repo
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: github-repo-secret
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repository
      data:
        name: github-k8s-myhome
        url: https://github.com/ksera524/k8s_myHome.git
        username: "ksera524"
        password: "{{ .image_updator }}"
        type: git
  data:
  - secretKey: image_updator
    remoteRef:
      key: image-updator

---
# Harbor Docker Registry Secret for ARC Controllers (arc-systems namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry-secret
  namespace: arc-systems
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-registry
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: v2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "192.168.122.100": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor

---
# Slack用ExternalSecret (sandbox namespace)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: slack-secret
  namespace: sandbox
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: slack-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: slack
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        SLACK_BOT_TOKEN: "{{ .slack | default \"\" }}"
        token: "{{ .slack | default \"\" }}"
  data:
  - secretKey: slack
    remoteRef:
      key: slack

---
# ArgoCD Image Updater用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-image-updater-secret
  namespace: argocd
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: argocd-image-updater
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: argocd-image-updater-secret
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
  data:
  - secretKey: argocd.token
    remoteRef:
      key: image-updator

---
# RustFS用ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: rustfs-auth
  namespace: rustfs
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: rustfs-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: rustfs-auth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
  data:
  - secretKey: RUSTFS_ACCESS_KEY
    remoteRef:
      key: rustfs.access_key
  - secretKey: RUSTFS_SECRET_KEY
    remoteRef:
      key: rustfs.secret_key

---
# sandbox向けRustFS認証ExternalSecret
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: rustfs-auth
  namespace: sandbox
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: rustfs-auth
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: rustfs-auth
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
  data:
  - secretKey: RUSTFS_ACCESS_KEY
    remoteRef:
      key: rustfs.access_key
  - secretKey: RUSTFS_SECRET_KEY
    remoteRef:
      key: rustfs.secret_key
