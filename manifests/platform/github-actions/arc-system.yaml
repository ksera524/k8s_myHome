# Actions Runner Controller System - External Secrets統合版
# External Secrets Operatorで管理されるGitHub/Harbor認証情報を利用
---
apiVersion: v1
kind: Namespace
metadata:
  name: actions-runner-system
---
# External Secret for GitHub Token
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: controller-manager
  namespace: actions-runner-system
spec:
  refreshInterval: 20s
  secretStoreRef:
    kind: ClusterSecretStore
    name: pulumi-esc-store
  target:
    name: controller-manager
    creationPolicy: Owner
  data:
  - secretKey: github_token
    remoteRef:
      key: github
      property: token
---
# External Secret for Harbor Registry
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-registry-secret
  namespace: actions-runner-system
spec:
  refreshInterval: 20s
  secretStoreRef:
    kind: ClusterSecretStore
    name: pulumi-esc-store
  target:
    name: harbor-registry-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "{{ .harbor_url }}": {
                "username": "{{ .harbor_username }}",
                "password": "{{ .harbor_password }}",
                "auth": "{{ printf "%s:%s" .harbor_username .harbor_password | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor_url
    remoteRef:
      key: harbor
      property: url
  - secretKey: harbor_username
    remoteRef:
      key: harbor
      property: username
  - secretKey: harbor_password
    remoteRef:
      key: harbor
      property: password
---
# 環境変数用ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-config
  namespace: actions-runner-system
data:
  HARBOR_URL: "192.168.122.100"
  HARBOR_PROJECT: "sandbox"
---
# Actions Runner Controller Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: actions-runner-controller
  namespace: actions-runner-system
  labels:
    app: actions-runner-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: actions-runner-controller
  template:
    metadata:
      labels:
        app: actions-runner-controller
    spec:
      serviceAccountName: actions-runner-controller
      containers:
      - name: manager
        image: sumologic/actions-runner-controller:v0.27.4
        command:
        - /manager
        args:
        - --enable-leader-election
        - --sync-period=1m
        env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: controller-manager
              key: github_token
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
        ports:
        - containerPort: 9443
          name: webhook-server
          protocol: TCP
        - containerPort: 8080
          name: metrics
          protocol: TCP
        volumeMounts:
        - mountPath: /tmp/k8s-webhook-server/serving-certs
          name: cert
          readOnly: true
      volumes:
      - name: cert
        secret:
          defaultMode: 420
          secretName: webhook-server-cert
      terminationGracePeriodSeconds: 10
---
# ServiceAccount for Actions Runner Controller
apiVersion: v1
kind: ServiceAccount
metadata:
  name: actions-runner-controller
  namespace: actions-runner-system
---
# ClusterRole for Actions Runner Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: actions-runner-controller
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  - events
  - persistentvolumeclaims
  - pods
  - secrets
  - services
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - apps
  resources:
  - deployments
  - replicasets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - actions.sumologic.com
  resources:
  - horizontalrunnerautoscalers
  - runnerdeployments
  - runnerreplicasets
  - runners
  - runnersets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - actions.sumologic.com
  resources:
  - horizontalrunnerautoscalers/finalizers
  - runnerdeployments/finalizers
  - runnerreplicasets/finalizers
  - runners/finalizers
  - runnersets/finalizers
  verbs:
  - update
- apiGroups:
  - actions.sumologic.com
  resources:
  - horizontalrunnerautoscalers/status
  - runnerdeployments/status
  - runnerreplicasets/status
  - runners/status
  - runnersets/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - create
  - get
  - list
  - update
---
# ClusterRoleBinding for Actions Runner Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: actions-runner-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: actions-runner-controller
subjects:
- kind: ServiceAccount
  name: actions-runner-controller
  namespace: actions-runner-system
---
# Service for Actions Runner Controller
apiVersion: v1
kind: Service
metadata:
  name: actions-runner-controller-webhook-service
  namespace: actions-runner-system
spec:
  ports:
  - port: 443
    targetPort: 9443
  selector:
    app: actions-runner-controller
---
# Service for metrics
apiVersion: v1
kind: Service
metadata:
  name: actions-runner-controller-metrics-service
  namespace: actions-runner-system
  labels:
    app: actions-runner-controller
spec:
  ports:
  - name: https
    port: 8443
    targetPort: 8080
  selector:
    app: actions-runner-controller
---
# Self-signed certificate for webhook
apiVersion: v1
kind: Secret
metadata:
  name: webhook-server-cert
  namespace: actions-runner-system
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURBVENDQWVtZ0F3SUJBZ0lKQU1yM0NFaytLSkNQTUEwR0NTcUdTSWIzRFFFQkN3VUFNQkV4RHpBTkJnTlYKQkFNTUJuTmxjblpsY2pBZUZ3MHlOVEF4TVRFME16WXhOV0ZhRncweU5qQXhNVEF6TmpGbE5XSmFNQkV4RHpBTgpCZ05WQkFNTUJuTmxjblpsY2pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTXNYCkVTY2N3R1kxZk8waXMwaTVENTNidHgwQ2RXeFF5eFZZWXNrQWN3bnJKNVhIdHdmTVowR3JCclluYnNJMjE2YXMKSzE2TUZKbHJIVERzamxqTklBQStxYkVZSTVDQTFGd2xxWnZQSGxIVE9vZGN5WGgyRmpUUE5PSzMvUE9TN2pMVApuUEY0Zlh5WVE2MjFUMzMzdks2V3JVdFltTUJDNWxFUGFFTW82TjNQc0VGUmZCNld6Rzh3YmNLYlpDSUU4b3dBCko2eTZBOE1yYks1U1FjSWZRU2Y0dFNkUmFjWjlBanpYS1htbkFGMVl3UjMzZGFiUnNXU1BqaHBkeDJJWnp6dEUKQWJZcVVnR1RTVzFaK29XMFd0K29VTGFUVHVqOUhSS3ZqMVhTR3ZUenU5VlBZK2R3Ym5hb1k2SnU2VW5jUlpHUQpJZUJGYUVTTDY5c1NQdktWaFVNQ0F3RUFBYU5RTUU0d0hRWURWUjBPQkJZRUZOcWRGdUF4cmg1K09aMFRWb21PCklOV0gvN29HTDNQYkY1aGxFNzVxUDBEL1c2dTNXaDczckI3UkhUU1YwOTVPdmhoT3VTMWJPQjc5NllhS3FIMApwVGJBTmlSeVMwNEswcUcvQ3RLVytxNGtWajZvTVhJSVRJK1J2ZGdIU05Ca2lyNUVITktRVTJNNm1CQSttZVNSClZqUnVYOEhoUXNzZVRDbUgvaWpCSUpDMU1qRHUrNmNWZmpwZUVNdWxrcHpNQTMrSllJblkvNTRJRm1IK3pqSG8KaDlRclFkUE9HVWphM3ZzS25LRW5VK21oZHFaQlhmMWlLdUNLVnZRZTIxZVp4NTNINktaTTNHZWxCUXczcFdCVgpHS1ZBMFN3QXJXSWdCWnhQQTgxTUFGcWJpNHZYUEZ6OGRjK3dJREFRQUJveUFBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRRExGeEVuSE1CbU5YenQKSXJOSXVRK2QyN2NkQW5Wc1VNc1ZXR0xKQUhNSjZ5ZVZ4N2NIekdkQnF3YTJKMjdDTnRlbXJDdGVqQlNaYXgwdwo3STVZelNBQVBxbXhHQ09RZ05SY0phbWJ6eDVSMHpxSFhNbDRkaFkwenpUaXQvenprdTR5MDV6eGVIMThpbE90CnRVOTk5NnkrdGl5RnJXSmlBUXVaUkQyaERLT2pkejdCQlVYd2VsOHh2TUczQ20yUWlCUEtNQUNlc3VnUERLMnkKdVVrSENIMEVuK0xVblVXbkdmUUk4MXlsNXB3QmRXTUVkOTNXbTBiRmtqNDRhWGNkaUdjODdSQUcySzFJQmswaApBZ0VRdGZiRnRGcmZxRkMya3c3by9SMFN3OTFWMGhyMDg3dlZUMlBuY0c1MnFHT2lidWxKM0VXUmtDSGdSV2hFCmkrdmJFajd5bFlWREFnTUJBQUVDZ2dFQkFLamZjMDBjTXdTdGNKNUdCVTNTajV1TTJRRStMMldLV1Owa1JqTEQKcnRHV1pXSFZsdDJvdnJlb2ZNdVNhNFJNRVFXdU0zSkdRaXh0TEwyK0J4eEZ4SllUdVNNWXR1MHNGVjRma2dOaApzV1FqdVRJUGdIdHl5TVJiYUMwMFhWQ1lHdE5aSGljTkFzakR1RE9HUVFBUXczQzZPUkJ6YXhvdXJ5Z1RaMmxQCjR6NVZUS0pGd21xSVhWRGhSYkpLM1VKekMyeUJFU3pzdEx3N0hHeHhHeVpNR3IrMGszQnhvaHZ1UUttM0VsaXMKNHpFQlgyUFM5a3NTOUVEOGZCRlJWb3hWMTZPZVZDSTh3NXpJNnFGSm1mZVBHVUlZMklJRFNEcGFzaUZpdlpzMQpFU1dJemVMTVMzQWwrR0tuZnB0L1JVZXZqQk1VdW5wMnZrZzhYaFM5ZlZVQ2dZRUEreE1VNXVxdGFyQTJqMGlYCjh5M1ltWEZ1aXF6VGcwT0ZYYVJ4TmJhOHZoQ1NObkI1TFBJYWY5QVRwdlRPSjZDbG9HVGl1TFRvRXNNa25sWC8KTFVYRC9mZkRXRjNhT044a085eFFubFlBOSsySGNraHNjOWs0VHRZK2lXZGNON0JKTWJOTkdWNGd2NVdJOXVlUwpuemF1Q0FCcU1FbG55VjlGOHo3WGlqdmVDWXNDZ1lFQTNKQ0tyYVk3bERCKzBEdFBYOFpqV2FHQ0N0Rzd5QVpUCjBYMXRwQ1V6YzFVdTJ0cVNScGt2STlQdlFmUUlFQitiOFhuOWpReFk5NjFYTHlxVXVGUVB3bGZvblI5bTlxKyoKUjhzQkZjZVVsL2FpZzYxeGpoalYxdTYzclJGZkFyS0tvMHFJQ2JuYlZORHNqNlh6OEhlZGN2RHE4bUFrcDA3VQpmbjlrRWNWUVNBQT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
---
# Custom Resource Definitions
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: runnerdeployments.actions.sumologic.com
spec:
  group: actions.sumologic.com
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              template:
                type: object
                properties:
                  spec:
                    type: object
                    properties:
                      repository:
                        type: string
                      group:
                        type: string
                      labels:
                        type: array
                        items:
                          type: string
                      image:
                        type: string
                      dockerdWithinRunnerContainer:
                        type: boolean
                      resources:
                        type: object
                      env:
                        type: array
                      volumeMounts:
                        type: array
                      volumes:
                        type: array
                      nodeSelector:
                        type: object
                      tolerations:
                        type: array
                      securityContext:
                        type: object
              replicas:
                type: integer
                minimum: 0
          status:
            type: object
  scope: Namespaced
  names:
    plural: runnerdeployments
    singular: runnerdeployment
    kind: RunnerDeployment
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: runners.actions.sumologic.com
spec:
  group: actions.sumologic.com
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              repository:
                type: string
              group:
                type: string
              labels:
                type: array
                items:
                  type: string
              image:
                type: string
              dockerdWithinRunnerContainer:
                type: boolean
              resources:
                type: object
              env:
                type: array
              volumeMounts:
                type: array
              volumes:
                type: array
              nodeSelector:
                type: object
              tolerations:
                type: array
              securityContext:
                type: object
          status:
            type: object
  scope: Namespaced
  names:
    plural: runners
    singular: runner
    kind: Runner
---
# ユーザーレベルのRunner Deployment
apiVersion: actions.sumologic.com/v1alpha1
kind: RunnerDeployment
metadata:
  name: user-runners
  namespace: actions-runner-system
spec:
  replicas: 2
  template:
    spec:
      repository: ksera524  # GitHubユーザー名
      labels:
        - self-hosted
        - linux
        - harbor-enabled
      
      image: sumologic/actions-runner:ubuntu-20.04
      
      # Docker-in-Dockerサポート
      dockerdWithinRunnerContainer: true
      
      # リソース制限
      resources:
        limits:
          cpu: "2"
          memory: "4Gi"
        requests:
          cpu: "500m"
          memory: "1Gi"
      
      # 環境変数
      env:
        - name: HARBOR_URL
          valueFrom:
            configMapKeyRef:
              name: runner-config
              key: HARBOR_URL
        - name: HARBOR_PROJECT
          valueFrom:
            configMapKeyRef:
              name: runner-config
              key: HARBOR_PROJECT
        - name: DOCKER_HOST
          value: tcp://localhost:2376
        - name: DOCKER_TLS_VERIFY
          value: "1"
        - name: DOCKER_CERT_PATH
          value: /certs/client
      
      # 永続ボリューム（ビルドキャッシュ用）
      volumeMounts:
        - name: docker-cache
          mountPath: /var/lib/docker
        - name: work-volume
          mountPath: /home/runner/_work
        - name: docker-certs
          mountPath: /certs/client
          readOnly: true
        - name: docker-auth
          mountPath: /home/runner/.docker
          readOnly: true
      
      volumes:
        - name: docker-cache
          emptyDir:
            sizeLimit: 10Gi
        - name: work-volume
          emptyDir:
            sizeLimit: 5Gi
        - name: docker-certs
          emptyDir: {}
        - name: docker-auth
          secret:
            secretName: harbor-registry-secret
            items:
              - key: .dockerconfigjson
                path: config.json
      
      # Node配置制御
      nodeSelector:
        kubernetes.io/arch: amd64
      
      tolerations: []