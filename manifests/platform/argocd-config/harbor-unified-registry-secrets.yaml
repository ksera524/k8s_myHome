# Harbor Unified Docker Registry Secrets for multiple namespaces
# Pulumiから取得したHarbor認証情報を各namespaceに作成
# harbor.localと192.168.122.100の両方をサポート

---
# Default namespace用
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry
  namespace: default
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-registry
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: v2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "harbor.local": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              },
              "192.168.122.100": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor

---
# Sandbox namespace用
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry
  namespace: sandbox
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-registry
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: v2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "harbor.local": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              },
              "192.168.122.100": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor

---
# Production namespace用
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry
  namespace: production
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-registry
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: v2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "harbor.local": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              },
              "192.168.122.100": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor

---
# Staging namespace用
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: harbor-registry
  namespace: staging
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: harbor-registry
    app.kubernetes.io/managed-by: argocd
spec:
  refreshInterval: 20s
  secretStoreRef:
    name: pulumi-esc-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      engineVersion: v2
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "harbor.local": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              },
              "192.168.122.100": {
                "username": "admin",
                "password": "{{ .harbor }}",
                "auth": "{{ printf "admin:%s" .harbor | b64enc }}"
              }
            }
          }
  data:
  - secretKey: harbor
    remoteRef:
      key: harbor