# k8s_myHome Automation Makefile
# å…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

# ã‚«ãƒ©ãƒ¼å®šç¾©
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

# è¨­å®š
PROJECT_ROOT := $(shell pwd)
HOST_SETUP_DIR := $(PROJECT_ROOT)/host-setup
INFRASTRUCTURE_DIR := $(PROJECT_ROOT)/infrastructure
PLATFORM_DIR := $(PROJECT_ROOT)/platform

.PHONY: help all deploy host-setup infrastructure platform vm-deploy vm-k8s-deploy k8s-cluster k8s-infrastructure clean verify status logs check-automation-readiness wait-for-k8s-cluster wait-for-external-secrets setup-slack-secret

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "$(GREEN)k8s_myHome Automation Commands$(NC)"
	@echo ""
	@echo "$(YELLOW)â–  å…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤$(NC)"
	@echo "  make all                 - å®Œå…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (å…¨ã‚¹ãƒ†ãƒƒãƒ—)"
	@echo "  make deploy              - å®Œå…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (allã¨åŒã˜)"
	@echo ""
	@echo "$(YELLOW)â–  ã‚¹ãƒ†ãƒƒãƒ—åˆ¥å®Ÿè¡Œ$(NC)"
	@echo "  make host-setup          - ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@echo "  make infrastructure      - VMä½œæˆ+Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰"
	@echo "  make platform            - Kubernetesãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ§‹ç¯‰"
	@echo ""
	@echo "$(YELLOW)â–  å€‹åˆ¥æ“ä½œ$(NC)"
	@echo "  make add-runner REPO=<name>  - GitHub Actions Runnerè¿½åŠ "
	@echo "  make setup-arc               - Actions Runner Controllerè¨­å®š"
	@echo "  make harbor-cert-fix         - Harborè¨¼æ˜æ›¸ä¿®æ­£"
	@echo "  make setup-slack-secret      - Slack Secretæ‰‹å‹•è¨­å®š"
	@echo ""
	@echo "$(YELLOW)â–  çŠ¶æ…‹ç¢ºèªãƒ»ç®¡ç†$(NC)"
	@echo "  make status              - å…¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª"
	@echo "  make verify              - å…¨ãƒ•ã‚§ãƒ¼ã‚ºæ¤œè¨¼"
	@echo "  make logs                - é‡è¦ãªãƒ­ã‚°è¡¨ç¤º"
	@echo "  make clean               - å…¨ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo ""
	@echo "$(YELLOW)â–  ä½¿ç”¨ä¾‹$(NC)"
	@echo "  make all                 # å®Œå…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make host-setup infrastructure  # ãƒ›ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã®ã¿"
	@echo "  make add-runner REPO=my-project  # Runnerè¿½åŠ "
	@echo ""

# å…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (å…¨ã‚¹ãƒ†ãƒƒãƒ—)
all: check-automation-readiness host-setup infrastructure platform
	@echo "$(GREEN)âœ… å…¨ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"
	@echo "$(YELLOW)ğŸ”§ ãƒã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ: GitOpsåŒæœŸã¨GitHub OAuthè¨­å®šç¢ºèªä¸­...$(NC)"
	@sleep 15  # GitOpsåŒæœŸå¾…æ©Ÿå»¶é•·
	@echo "$(YELLOW)ğŸ”„ External Secretsè¨­å®šå¼·åˆ¶åŒæœŸä¸­...$(NC)"
	@ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl patch application applications -n argocd --type merge -p '\''{\"metadata\":{\"annotations\":{\"argocd.argoproj.io/refresh\":\"hard\"}}}'\''' || true
	@sleep 10  # ArgoCDåŒæœŸå¾…æ©Ÿ
	@echo "$(YELLOW)â˜ï¸ Cloudflaredã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªãƒ»ä½œæˆä¸­...$(NC)"
	@ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'if ! kubectl get application cloudflared -n argocd >/dev/null 2>&1; then kubectl apply -f - <<EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cloudflared
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/ksera524/k8s_myHome.git
    targetRevision: HEAD
    path: manifests/applications/cloudflared
  destination:
    server: https://kubernetes.default.svc
    namespace: cloudflared
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF
echo "âœ… Cloudflaredã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†"; else echo "âœ… Cloudflaredã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã¾ã™"; fi' || echo "âš ï¸ Cloudflaredã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
	@cd $(PLATFORM_DIR) && ./setup-argocd-github-oauth.sh || echo "$(YELLOW)âš ï¸ ArgoCD GitHub OAuthè¨­å®šã§è­¦å‘ŠãŒç™ºç”Ÿã—ã¾ã—ãŸãŒç¶šè¡Œã—ã¾ã™$(NC)"
	@echo "$(GREEN)âœ… ãƒã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†$(NC)"
	@echo ""
	@$(MAKE) status

# deployã¯allã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
deploy: all

# ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
host-setup:
	@echo "$(GREEN)ğŸš€ ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹$(NC)"
	@cd $(HOST_SETUP_DIR) && ./setup-host.sh
	@echo "$(YELLOW)âš ï¸  ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®æ›´æ–°ã®ãŸã‚ã€æ¨©é™ã‚’å†ç¢ºèªã—ã¾ã™$(NC)"
	@if ! groups | grep -q libvirt; then \
		echo "$(YELLOW)libvirtã‚°ãƒ«ãƒ¼ãƒ—ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚sg libvirtã§å®Ÿè¡Œã—ã¾ã™...$(NC)"; \
		sg libvirt -c "cd $(HOST_SETUP_DIR) && ./setup-storage.sh"; \
		sg libvirt -c "cd $(HOST_SETUP_DIR) && ./verify-setup.sh"; \
	else \
		echo "$(GREEN)libvirtã‚°ãƒ«ãƒ¼ãƒ—ãŒæœ‰åŠ¹ã§ã™ã€‚ç¶šè¡Œã—ã¾ã™...$(NC)"; \
		cd $(HOST_SETUP_DIR) && ./setup-storage.sh; \
		cd $(HOST_SETUP_DIR) && ./verify-setup.sh; \
	fi
	@echo "$(GREEN)âœ… ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†$(NC)"

# ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹ç¯‰ (VM + Kubernetesã‚¯ãƒ©ã‚¹ã‚¿)
infrastructure:
	@echo "$(GREEN)ğŸš€ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹ç¯‰é–‹å§‹ (VM + Kubernetesã‚¯ãƒ©ã‚¹ã‚¿)$(NC)"
	@cd $(INFRASTRUCTURE_DIR) && ./clean-and-deploy.sh
	@echo "$(YELLOW)ğŸ• ã‚¯ãƒ©ã‚¹ã‚¿æº–å‚™å®Œäº†ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...$(NC)"
	@$(MAKE) wait-for-k8s-cluster
	@echo "$(GREEN)âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹ç¯‰å®Œäº†$(NC)"

# Kubernetesãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ§‹ç¯‰
platform:
	@echo "$(GREEN)ğŸš€ Kubernetesãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ§‹ç¯‰é–‹å§‹$(NC)"
	@cd $(PLATFORM_DIR) && NON_INTERACTIVE=true ./phase4-deploy.sh
	@echo "$(YELLOW)ğŸ• External SecretsåŒæœŸç¢ºèªä¸­...$(NC)"
	@$(MAKE) wait-for-external-secrets
	@echo "$(YELLOW)ğŸ” ArgoCD GitHub OAuthè¨­å®šä¸­...$(NC)" 
	@cd $(PLATFORM_DIR) && ./setup-argocd-github-oauth.sh || echo "$(YELLOW)âš ï¸ ArgoCD GitHub OAuthè¨­å®šã§è­¦å‘ŠãŒç™ºç”Ÿã—ã¾ã—ãŸãŒç¶šè¡Œã—ã¾ã™$(NC)"
	@echo "$(GREEN)âœ… Kubernetesãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ§‹ç¯‰å®Œäº†$(NC)"

# å¾Œæ–¹äº’æ›æ€§ç”¨ï¼ˆéæ¨å¥¨ï¼‰
vm-deploy: infrastructure
	@echo "$(YELLOW)âš ï¸  vm-deployã¯éæ¨å¥¨ã§ã™ã€‚infrastructureã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„$(NC)"

vm-k8s-deploy: infrastructure
	@echo "$(YELLOW)âš ï¸  vm-k8s-deployã¯éæ¨å¥¨ã§ã™ã€‚infrastructureã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„$(NC)"

k8s-cluster: infrastructure
	@echo "$(YELLOW)âš ï¸  k8s-clusterã¯éæ¨å¥¨ã§ã™ã€‚infrastructureã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„$(NC)"

k8s-infrastructure: platform
	@echo "$(YELLOW)âš ï¸  k8s-infrastructureã¯éæ¨å¥¨ã§ã™ã€‚platformã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„$(NC)"

# GitHub Actions Runnerè¿½åŠ 
add-runner:
	@if [ -z "$(REPO)" ]; then \
		echo "$(RED)âŒ ã‚¨ãƒ©ãƒ¼: REPOå¤‰æ•°ãŒå¿…è¦ã§ã™$(NC)"; \
		echo "ä½¿ç”¨æ–¹æ³•: make add-runner REPO=repository-name"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸš€ GitHub Actions Runnerè¿½åŠ : $(REPO)$(NC)"
	@cd $(PLATFORM_DIR) && ./add-runner.sh $(REPO)
	@echo "$(GREEN)âœ… Runnerè¿½åŠ å®Œäº†$(NC)"

# Actions Runner Controllerè¨­å®š
setup-arc:
	@echo "$(GREEN)ğŸš€ Actions Runner Controllerè¨­å®šé–‹å§‹$(NC)"
	@cd $(PLATFORM_DIR) && NON_INTERACTIVE=true ./setup-arc.sh
	@echo "$(GREEN)âœ… ARCè¨­å®šå®Œäº†$(NC)"

# Harborè¨¼æ˜æ›¸ä¿®æ­£
harbor-cert-fix:
	@echo "$(GREEN)ğŸš€ Harborè¨¼æ˜æ›¸ä¿®æ­£é–‹å§‹$(NC)"
	@cd $(PLATFORM_DIR) && ./harbor-cert-fix.sh
	@echo "$(GREEN)âœ… Harborè¨¼æ˜æ›¸ä¿®æ­£å®Œäº†$(NC)"

# Slack Secretæ‰‹å‹•è¨­å®š
setup-slack-secret:
	@echo "$(GREEN)ğŸš€ Slack Secretæ‰‹å‹•è¨­å®šé–‹å§‹$(NC)"
	@cd $(PLATFORM_DIR)/external-secrets && ./deploy-slack-secrets.sh
	@echo "$(GREEN)âœ… Slack Secretè¨­å®šå®Œäº†$(NC)"

# å…¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
status:
	@echo "$(GREEN)ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª$(NC)"
	@echo ""
	@echo "$(YELLOW)â–  VMçŠ¶æ…‹$(NC)"
	@sudo virsh list --all 2>/dev/null || echo "libvirtãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
	@echo ""
	@echo "$(YELLOW)â–  Kubernetesã‚¯ãƒ©ã‚¹ã‚¿çŠ¶æ…‹$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get nodes' 2>/dev/null || echo "Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã«æ¥ç¶šã§ãã¾ã›ã‚“"
	@echo ""
	@echo "$(YELLOW)â–  ArgoCD ApplicationsçŠ¶æ…‹$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get applications -n argocd' 2>/dev/null || echo "ArgoCD ApplicationsãŒç¢ºèªã§ãã¾ã›ã‚“"
	@echo ""
	@echo "$(YELLOW)â–  LoadBalancer IP$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl -n ingress-nginx get service ingress-nginx-controller -o jsonpath="{.status.loadBalancer.ingress[0].ip}"' 2>/dev/null || echo "LoadBalancer IPãŒå–å¾—ã§ãã¾ã›ã‚“"
	@echo ""
	@echo "$(YELLOW)â–  External SecretsçŠ¶æ…‹$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get externalsecrets -A | grep -E "(github-auth|slack-externalsecret)" | while read ns name store refresh status ready; do echo "  $$name ($$ns): $$status/$$ready"; done' 2>/dev/null || echo "External SecretsçŠ¶æ…‹ãŒç¢ºèªã§ãã¾ã›ã‚“"
	@echo ""

# å…¨ãƒ•ã‚§ãƒ¼ã‚ºæ¤œè¨¼
verify:
	@echo "$(GREEN)ğŸ” å…¨ãƒ•ã‚§ãƒ¼ã‚ºæ¤œè¨¼é–‹å§‹$(NC)"
	@echo ""
	@echo "$(YELLOW)â–  ãƒ›ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¤œè¨¼$(NC)"
	@cd $(HOST_SETUP_DIR) && ./verify-setup.sh 2>/dev/null || echo "ãƒ›ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¤œè¨¼å¤±æ•—"
	@echo ""
	@echo "$(YELLOW)â–  ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ¤œè¨¼$(NC)"
	@cd $(INFRASTRUCTURE_DIR) && terraform plan -out=tfplan >/dev/null 2>&1 && echo "âœ… TerraformçŠ¶æ…‹æ­£å¸¸" || echo "âŒ TerraformçŠ¶æ…‹ç•°å¸¸"
	@echo ""
	@echo "$(YELLOW)â–  Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ç¨¼åƒæ¤œè¨¼$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get nodes --no-headers | grep -c Ready' 2>/dev/null | \
		awk '{if($$1>=3) print "âœ… Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æ­£å¸¸ ("$$1" nodes Ready)"; else print "âŒ Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ç•°å¸¸"}' || echo "âŒ Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æ¥ç¶šå¤±æ•—"
	@echo ""
	@echo "$(YELLOW)â–  Kubernetesãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get pods --all-namespaces | grep -E "(metallb|ingress|cert-manager|argocd|harbor)" | grep -c Running' 2>/dev/null | \
		awk '{if($$1>=10) print "âœ… åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©æ­£å¸¸ ("$$1" pods Running)"; else print "âŒ åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ç•°å¸¸ ("$$1" pods Running)"}' || echo "âŒ åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©ç¢ºèªå¤±æ•—"
	@echo ""
	@echo "$(YELLOW)â–  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨¼$(NC)"
	@slack_pods=$$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get pods -n sandbox | grep slack | grep -c Running' 2>/dev/null || echo "0"); \
	if [ "$$slack_pods" -gt 0 ]; then \
		echo "âœ… Slack ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ­£å¸¸ ($$slack_pods pods Running)"; \
	else \
		echo "âŒ Slack ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç•°å¸¸ (0 pods Running)"; \
	fi || echo "âŒ Slack ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèªå¤±æ•—"

# é‡è¦ãªãƒ­ã‚°è¡¨ç¤º
logs:
	@echo "$(GREEN)ğŸ“‹ é‡è¦ãªãƒ­ã‚°è¡¨ç¤º$(NC)"
	@echo ""
	@echo "$(YELLOW)â–  ArgoCDåˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d' 2>/dev/null || echo "ArgoCDåˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå–å¾—ã§ãã¾ã›ã‚“"
	@echo ""
	@echo ""
	@echo "$(YELLOW)â–  GitHubèªè¨¼æƒ…å ±çŠ¶æ…‹$(NC)"
	@cd $(PLATFORM_DIR) && source ./github-auth-utils.sh && show_github_credentials_status 2>/dev/null || echo "GitHubèªè¨¼æƒ…å ±ãŒç¢ºèªã§ãã¾ã›ã‚“"
	@echo ""
	@echo "$(YELLOW)â–  æœ€è¿‘ã®é‡è¦ãªãƒãƒƒãƒ‰çŠ¶æ…‹$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get pods --all-namespaces | grep -E "(argocd|harbor|actions-runner|slack)" | tail -10' 2>/dev/null || echo "ãƒãƒƒãƒ‰çŠ¶æ…‹ãŒç¢ºèªã§ãã¾ã›ã‚“"
	@echo ""
	@echo "$(YELLOW)â–  Slack SecretçŠ¶æ…‹$(NC)"
	@ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get secret slack -n sandbox --no-headers 2>/dev/null | awk "{print \"Secret slack: \" \$$2 \" (\" \$$3 \" keys) Age: \" \$$4}"' 2>/dev/null || echo "Slack SecretãŒç¢ºèªã§ãã¾ã›ã‚“"
	@echo ""

# è‡ªå‹•åŒ–å®Ÿè¡Œã®äº‹å‰ãƒã‚§ãƒƒã‚¯
check-automation-readiness:
	@echo "$(GREEN)ğŸ” è‡ªå‹•åŒ–å®Ÿè¡Œã®äº‹å‰ãƒã‚§ãƒƒã‚¯$(NC)"
	@echo "$(YELLOW)â–  å®Ÿè¡Œç’°å¢ƒç¢ºèª$(NC)"
	@if [ "$(shell whoami)" = "root" ]; then \
		echo "$(RED)âŒ ã‚¨ãƒ©ãƒ¼: rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“$(NC)"; \
		exit 1; \
	fi
	@if [ ! -d "$(PROJECT_ROOT)" ]; then \
		echo "$(RED)âŒ ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… äº‹å‰ãƒã‚§ãƒƒã‚¯å®Œäº†$(NC)"


# Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æº–å‚™å®Œäº†å¾…æ©Ÿ
wait-for-k8s-cluster:
	@echo "$(YELLOW)ğŸ• Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿä¸­...$(NC)"
	@timeout=300; \
	while [ $$timeout -gt 0 ]; do \
		ready_nodes=$$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get nodes --no-headers 2>/dev/null | grep -c Ready' 2>/dev/null || echo "0"); \
		if [ "$$ready_nodes" -ge 3 ]; then \
			echo "$(GREEN)âœ… Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æº–å‚™å®Œäº† ($$ready_nodes nodes Ready)$(NC)"; \
			break; \
		fi; \
		echo "Ready ãƒãƒ¼ãƒ‰æ•°: $$ready_nodes/3 - ã‚ã¨ $$timeout ç§’å¾…æ©Ÿ..."; \
		sleep 10; \
		timeout=$$((timeout - 10)); \
	done; \
	if [ $$timeout -le 0 ]; then \
		echo "$(RED)âŒ Kubernetesã‚¯ãƒ©ã‚¹ã‚¿æº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ$(NC)"; \
		exit 1; \
	fi

# External SecretsåŒæœŸå®Œäº†å¾…æ©Ÿ
wait-for-external-secrets:
	@echo "$(YELLOW)ğŸ• External SecretsåŒæœŸå®Œäº†ã‚’å¾…æ©Ÿä¸­...$(NC)"
	@timeout=180; \
	github_secret_ready=false; \
	slack_secret_ready=false; \
	argocd_oauth_ready=false; \
	cloudflared_secret_ready=false; \
	while [ $$timeout -gt 0 ]; do \
		# GitHub External Secretç¢ºèª \
		if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get externalsecret github-auth-secret -n arc-systems' >/dev/null 2>&1; then \
			github_ready=$$(ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl get externalsecret github-auth-secret -n arc-systems -o jsonpath="{.status.conditions[?(@.type==\"Ready\")].status}"' 2>/dev/null || echo "False"); \
			if [ "$$github_ready" = "True" ]; then \
				echo "$(GREEN)âœ… GitHub External Secretæº–å‚™å®Œäº†$(NC)"; \
				github_secret_ready=true; \
			fi; \
		fi; \
		# ArgoCD GitHub OAuth External Secretç¢ºèª \
		if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get externalsecret argocd-github-oauth-secret -n argocd' >/dev/null 2>&1; then \
			argocd_oauth_ready_status=$$(ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl get externalsecret argocd-github-oauth-secret -n argocd -o jsonpath="{.status.conditions[?(@.type==\"Ready\")].status}"' 2>/dev/null || echo "False"); \
			if [ "$$argocd_oauth_ready_status" = "True" ]; then \
				echo "$(GREEN)âœ… ArgoCD GitHub OAuth External Secretæº–å‚™å®Œäº†$(NC)"; \
				argocd_oauth_ready=true; \
			fi; \
		fi; \
		# Slack External Secretç¢ºèª \
		if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get externalsecret slack-externalsecret -n sandbox' >/dev/null 2>&1; then \
			slack_ready=$$(ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl get externalsecret slack-externalsecret -n sandbox -o jsonpath="{.status.conditions[?(@.type==\"Ready\")].status}"' 2>/dev/null || echo "False"); \
			if [ "$$slack_ready" = "True" ]; then \
				echo "$(GREEN)âœ… Slack External Secretæº–å‚™å®Œäº†$(NC)"; \
				slack_secret_ready=true; \
			fi; \
		fi; \
		# Cloudflared External Secretç¢ºèª \
		if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 k8suser@192.168.122.10 'kubectl get externalsecret cloudflared-secret -n cloudflared' >/dev/null 2>&1; then \
			cloudflared_ready=$$(ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl get externalsecret cloudflared-secret -n cloudflared -o jsonpath="{.status.conditions[?(@.type==\"Ready\")].status}"' 2>/dev/null || echo "False"); \
			if [ "$$cloudflared_ready" = "True" ]; then \
				echo "$(GREEN)âœ… Cloudflared External Secretæº–å‚™å®Œäº†$(NC)"; \
				cloudflared_secret_ready=true; \
			fi; \
		fi; \
		# å…¨ã¦æº–å‚™å®Œäº†ãªã‚‰çµ‚äº† \
		if [ "$$github_secret_ready" = "true" ] && [ "$$slack_secret_ready" = "true" ] && [ "$$argocd_oauth_ready" = "true" ] && [ "$$cloudflared_secret_ready" = "true" ]; then \
			break; \
		fi; \
		echo "External Secretå¾…æ©Ÿä¸­... GitHub:$$github_secret_ready Slack:$$slack_secret_ready ArgoCD:$$argocd_oauth_ready Cloudflared:$$cloudflared_secret_ready (æ®‹ã‚Š $$timeout ç§’)"; \
		sleep 10; \
		timeout=$$((timeout - 10)); \
	done; \
	if [ "$$github_secret_ready" = "false" ]; then \
		echo "$(YELLOW)âš ï¸ GitHub External Secretæº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œã—ã¾ã™ï¼‰$(NC)"; \
	fi; \
	if [ "$$slack_secret_ready" = "false" ]; then \
		echo "$(YELLOW)âš ï¸ Slack External Secretæº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ$(NC)"; \
	fi; \
	if [ "$$argocd_oauth_ready" = "false" ]; then \
		echo "$(YELLOW)âš ï¸ ArgoCD GitHub OAuth External Secretæº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆãƒã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã§å†è©¦è¡Œã—ã¾ã™ï¼‰$(NC)"; \
	fi; \
	if [ "$$cloudflared_secret_ready" = "false" ]; then \
		echo "$(YELLOW)âš ï¸ Cloudflared External Secretæº–å‚™ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆæ‰‹å‹•ã§åŒæœŸç¢ºèªã—ã¦ãã ã•ã„ï¼‰$(NC)"; \
	fi

# å…¨ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "$(RED)âš ï¸  å…¨ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™$(NC)"
	@echo "ã“ã®æ“ä½œã¯ä»¥ä¸‹ã‚’å‰Šé™¤ã—ã¾ã™:"
	@echo "  - å…¨VM"
	@echo "  - Terraformãƒªã‚½ãƒ¼ã‚¹"
	@echo "  - GitHubèªè¨¼æƒ…å ±"
	@echo ""
	@bash -c 'read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " -r REPLY; \
	if [ "$$REPLY" = "y" ] || [ "$$REPLY" = "Y" ]; then \
		echo "$(YELLOW)ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹...$(NC)"; \
		sudo virsh list --all | grep k8s | awk '"'"'{print $$2}'"'"' | xargs -I {} sudo virsh destroy {} 2>/dev/null || true; \
		sudo virsh list --all | grep k8s | awk '"'"'{print $$2}'"'"' | xargs -I {} sudo virsh undefine {} 2>/dev/null || true; \
		cd $(INFRASTRUCTURE_DIR) && terraform destroy -auto-approve 2>/dev/null || true; \
		cd $(PLATFORM_DIR) && source ./github-auth-utils.sh && clear_github_credentials 2>/dev/null || true; \
		echo "$(GREEN)âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†$(NC)"; \
	else \
		echo "$(YELLOW)ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ$(NC)"; \
	fi'

# å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
.PHONY: phase1 phase2 phase3 phase4 phase2-3
phase1: host-setup
phase2-3: infrastructure
phase4: platform

# éæ¨å¥¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹
phase2: infrastructure
	@echo "$(YELLOW)âš ï¸  phase2ã¯çµ±åˆã•ã‚Œã¾ã—ãŸã€‚infrastructureãŒå®Ÿè¡Œã•ã‚Œã¾ã™$(NC)"
phase3: infrastructure
	@echo "$(YELLOW)âš ï¸  phase3ã¯çµ±åˆã•ã‚Œã¾ã—ãŸã€‚infrastructureãŒå®Ÿè¡Œã•ã‚Œã¾ã™$(NC)"

# é–‹ç™ºç”¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.PHONY: dev-info dev-ssh dev-argocd dev-harbor

# é–‹ç™ºç”¨æƒ…å ±è¡¨ç¤º
dev-info:
	@echo "$(GREEN)ğŸ”§ é–‹ç™ºç”¨æƒ…å ±$(NC)"
	@echo ""
	@echo "$(YELLOW)â–  é‡è¦ãªURL$(NC)"
	@echo "ArgoCD: https://argocd.local (LoadBalancer) ã¾ãŸã¯ kubectl port-forward svc/argocd-server -n argocd 8080:443"
	@echo "Harbor: https://harbor.local (LoadBalancer) ã¾ãŸã¯ kubectl port-forward svc/harbor-core -n harbor 8081:80"
	@echo ""
	@echo "$(YELLOW)â–  SSHæ¥ç¶š$(NC)"
	@echo "Control Plane: ssh k8suser@192.168.122.10"
	@echo "Worker Node 1: ssh k8suser@192.168.122.11"
	@echo "Worker Node 2: ssh k8suser@192.168.122.12"
	@echo ""
	@echo "$(YELLOW)â–  ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰$(NC)"
	@echo "kubectl get pods --all-namespaces"
	@echo "kubectl -n argocd get applications"
	@echo "kubectl -n harbor get pods"

# Control Planeã¸ã®ç°¡å˜SSH
dev-ssh:
	@ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10

# ArgoCD Port Forward
dev-argocd:
	@echo "$(GREEN)ğŸŒ ArgoCD Port Forwardé–‹å§‹ (localhost:8080)$(NC)"
	@ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl port-forward svc/argocd-server -n argocd 8080:443'

# Harbor Port Forward
dev-harbor:
	@echo "$(GREEN)ğŸŒ Harbor Port Forwardé–‹å§‹ (localhost:8081)$(NC)"
	@ssh -o StrictHostKeyChecking=no k8suser@192.168.122.10 'kubectl port-forward svc/harbor-core -n harbor 8081:80'