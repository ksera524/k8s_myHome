#!/bin/bash

# GitHub Actions Runner Controller (ARC) - æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªç”¨Runnerè¿½åŠ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# å…¬å¼GitHub ARCå¯¾å¿œç‰ˆ - ã‚¯ãƒªãƒ¼ãƒ³ã§ç°¡æ½”ãªå®Ÿè£…

set -euo pipefail

# å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
source "$SCRIPTS_ROOT/common-k8s-utils.sh"
source "$SCRIPTS_ROOT/common-logging.sh"

# å¼•æ•°ç¢ºèª
if [[ $# -lt 1 ]]; then
    log_error "ä½¿ç”¨æ–¹æ³•: $0 <repository-name> [min-runners] [max-runners]"
    log_error "ä¾‹: $0 my-awesome-project 1 3"
    exit 1
fi

REPOSITORY_NAME="$1"
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆå¼•æ•°ãŒæ¸¡ã•ã‚Œãªã„å ´åˆï¼‰
MIN_RUNNERS="${2:-1}"
MAX_RUNNERS="${3:-3}"
# Runneråç”Ÿæˆï¼ˆå°æ–‡å­—å¤‰æ›ã€ãƒ‰ãƒƒãƒˆãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’ãƒã‚¤ãƒ•ãƒ³ã«å¤‰æ›ï¼‰
RUNNER_NAME="$(echo "${REPOSITORY_NAME}" | tr '[:upper:]._' '[:lower:]--')-runners"

log_status "=== GitHub Actions Runnerè¿½åŠ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (å…¬å¼ARCå¯¾å¿œ) ==="
log_debug "å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª: $REPOSITORY_NAME"
log_debug "Runnerå: $RUNNER_NAME"
log_debug "Min Runners: $MIN_RUNNERS"
log_debug "Max Runners: $MAX_RUNNERS"

# GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ï¼ˆsettings.tomlã‹ã‚‰ï¼‰
# settings.tomlã¯automationç›´ä¸‹ã«ã‚ã‚‹
SETTINGS_FILE="$SCRIPTS_ROOT/../settings.toml"
if [[ ! -f "$SETTINGS_FILE" ]]; then
    # åˆ¥ã®å ´æ‰€ã‚‚è©¦ã™ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆï¼‰
    SETTINGS_FILE="$SCRIPTS_ROOT/../../settings.toml"
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        # platform-deploy.shã‹ã‚‰å‘¼ã°ã‚Œã‚‹å ´åˆ
        SETTINGS_FILE="$(dirname "$SCRIPTS_ROOT")/settings.toml"
        if [[ ! -f "$SETTINGS_FILE" ]]; then
            log_error "settings.tomlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            log_error "automation/settings.tomlã‚’ä½œæˆã—ã¦ãã ã•ã„"
            exit 1
        fi
    fi
fi

log_debug "settings.tomlãƒ•ã‚¡ã‚¤ãƒ«: $SETTINGS_FILE"
GITHUB_USERNAME=$(grep '^username = ' "$SETTINGS_FILE" | head -1 | cut -d'"' -f2)
if [[ -z "$GITHUB_USERNAME" ]]; then
    log_error "settings.tomlã®github.usernameãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    log_error "ãƒ•ã‚¡ã‚¤ãƒ«: $SETTINGS_FILE"
    exit 1
fi
log_debug "GitHub Username: $GITHUB_USERNAME"

PROJECT_ROOT="$(cd "$SCRIPTS_ROOT/../.." && pwd)"
APPSET_FILE="$PROJECT_ROOT/manifests/platform/ci-cd/github-actions/runners-appset.yaml"

if [[ ! -f "$APPSET_FILE" ]]; then
    log_error "ApplicationSetå®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $APPSET_FILE"
    exit 1
fi

log_status "=== Runnerå®šç¾©ã‚’GitOpsç®¡ç†ã¸ç™»éŒ² ==="
UPSERT_RESULT=$(python3 - <<PY
import re
import sys
from pathlib import Path
import yaml

appset_path = Path(r"$APPSET_FILE")
repo_name = r"$REPOSITORY_NAME"
min_runners = str(r"$MIN_RUNNERS")
max_runners = str(r"$MAX_RUNNERS")
github_owner = r"$GITHUB_USERNAME"

doc = yaml.safe_load(appset_path.read_text(encoding="utf-8"))
elements = doc["spec"]["generators"][0]["list"]["elements"]

slug = re.sub(r"[._]", "-", repo_name.lower())
entry = {
    "name": slug,
    "githubOwner": github_owner,
    "githubRepo": repo_name,
    "runnerName": f"{slug}-runners",
    "minRunners": min_runners,
    "maxRunners": max_runners,
}

updated = False
for i, e in enumerate(elements):
    if e.get("runnerName") == entry["runnerName"] or e.get("githubRepo") == repo_name:
        if e != entry:
            elements[i] = entry
            updated = True
        print("updated" if updated else "unchanged")
        break
else:
    elements.append(entry)
    updated = True
    print("added")

if updated:
    appset_path.write_text(yaml.safe_dump(doc, sort_keys=False, allow_unicode=False), encoding="utf-8")
PY
)

case "$UPSERT_RESULT" in
    added)
        log_status "âœ“ Runnerå®šç¾©ã‚’è¿½åŠ ã—ã¾ã—ãŸ: $REPOSITORY_NAME"
        ;;
    updated)
        log_status "âœ“ Runnerå®šç¾©ã‚’æ›´æ–°ã—ã¾ã—ãŸ: $REPOSITORY_NAME"
        ;;
    unchanged)
        log_status "âœ“ Runnerå®šç¾©ã¯æœ€æ–°ã§ã™: $REPOSITORY_NAME"
        ;;
    *)
        log_error "Runnerå®šç¾©ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
        ;;
esac

log_status "â„¹ï¸ Runneræœ¬ä½“ã¯ArgoCD(ApplicationSet)çµŒç”±ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™"
log_status "â„¹ï¸ åæ˜ ã«ã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®commit/pushãŒå¿…è¦ã§ã™"

# GitHub Actions workflowä½œæˆ
log_status "=== GitHub Actions workflowä½œæˆ ==="

WORKFLOW_DIR=".github/workflows"
WORKFLOW_FILE="$WORKFLOW_DIR/build-and-push-$REPOSITORY_NAME.yml"

# .github/workflowsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$WORKFLOW_DIR"
log_debug "Workflowãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ: $WORKFLOW_DIR"

# workflow.yamlãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
log_debug "Workflowãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆä¸­: $WORKFLOW_FILE"
cat > "$WORKFLOW_FILE" << WORKFLOW_EOF
# GitHub Actions workflow for $REPOSITORY_NAME
# Auto-generated by add-runner.sh (å…¬å¼ARCå¯¾å¿œç‰ˆ) - Auto Semverç‰ˆ

name: Build and Push to Harbor - $REPOSITORY_NAME

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write  # ã‚¿ã‚°ã®ä½œæˆã¨pushã«å¿…è¦
  pull-requests: read

jobs:
  build-and-push:
    runs-on: $RUNNER_NAME  # Kubernetes Runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚¿ã‚°æƒ…å ±ã‚’å–å¾—
      
    - name: Auto increment version
      id: version
      run: |
        # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯0.0.0ã‹ã‚‰é–‹å§‹ï¼‰
        LATEST_TAG=\$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: \$LATEST_TAG"
        
        # v prefix ã‚’å‰Šé™¤
        LATEST_VERSION=\${LATEST_TAG#v}
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ†è§£
        IFS='.' read -r MAJOR MINOR PATCH <<< "\$LATEST_VERSION"
        
        if [[ "\${{ github.event_name }}" == "pull_request" ]]; then
          # PRæ™‚ã¯ãƒ“ãƒ«ãƒ‰ã®ã¿ã€pushã—ãªã„
          VERSION="pr-\${{ github.event.pull_request.number }}-\$(git rev-parse --short HEAD)"
          echo "version=\$VERSION" >> \$GITHUB_OUTPUT
          echo "should_push=false" >> \$GITHUB_OUTPUT
          echo "should_tag=false" >> \$GITHUB_OUTPUT
          echo "ğŸ” PR Build: \$VERSION (build only, no push)"
        else
          # main/masterã¸ã®pushæ™‚ã¯è‡ªå‹•çš„ã«ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          PATCH=\$((PATCH + 1))
          NEW_VERSION="\$MAJOR.\$MINOR.\$PATCH"
          
          echo "version=\$NEW_VERSION" >> \$GITHUB_OUTPUT
          echo "should_push=true" >> \$GITHUB_OUTPUT
          echo "should_tag=true" >> \$GITHUB_OUTPUT
          echo "ğŸ“¦ New Version: \$NEW_VERSION (auto-incremented from \$LATEST_VERSION)"
        fi
      
    - name: Setup kubectl and Harbor credentials
      run: |
        echo "=== Setup kubectl and Harbor credentials ==="
        
        # Install kubectl
        echo "Installing kubectl..."
        curl -LO "https://dl.k8s.io/release/\$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Configure kubectl for in-cluster access
        echo "Configuring kubectl..."
        export KUBECONFIG=/tmp/kubeconfig
        kubectl config set-cluster default \\
            --server=https://kubernetes.default.svc \\
            --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \\
            --kubeconfig=\$KUBECONFIG
        kubectl config set-credentials default \\
            --token=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) \\
            --kubeconfig=\$KUBECONFIG
        kubectl config set-context default \\
            --cluster=default --user=default \\
            --kubeconfig=\$KUBECONFIG
        kubectl config use-context default --kubeconfig=\$KUBECONFIG
        
        # Get Harbor credentials
        echo "Getting Harbor credentials..."
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_USERNAME}' | base64 -d > /tmp/harbor_username
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PASSWORD}' | base64 -d > /tmp/harbor_password
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_URL}' | base64 -d > /tmp/harbor_url
        kubectl get secret harbor-auth -n arc-systems -o jsonpath='{.data.HARBOR_PROJECT}' | base64 -d > /tmp/harbor_project
        kubectl get secret ca-key-pair -n cert-manager -o jsonpath='{.data.ca\.crt}' | base64 -d > /tmp/harbor_ca.crt
        
        chmod 600 /tmp/harbor_*
        echo "âœ… Harbor credentials retrieved successfully"
        
    - name: Build and push images using Docker
      run: |
        echo "=== Build and push images using Docker ==="
        
        HARBOR_USERNAME=\$(cat /tmp/harbor_username)
        HARBOR_PASSWORD=\$(cat /tmp/harbor_password)
        HARBOR_URL="harbor.internal.qroksera.com"
        HARBOR_PROJECT=\$(cat /tmp/harbor_project)
        VERSION="\${{ steps.version.outputs.version }}"
        SHOULD_PUSH="\${{ steps.version.outputs.should_push }}"

        # å†…éƒ¨CAã‚’ä¿¡é ¼ã‚¹ãƒˆã‚¢ã«è¿½åŠ 
        echo "Installing internal CA..."
        sudo cp /tmp/harbor_ca.crt /usr/local/share/ca-certificates/harbor-internal-ca.crt
        sudo update-ca-certificates

        # Dockerç”¨ã®CAè¨­å®š
        echo "Configuring Docker CA..."
        sudo mkdir -p /etc/docker/certs.d/harbor.internal.qroksera.com
        sudo cp /tmp/harbor_ca.crt /etc/docker/certs.d/harbor.internal.qroksera.com/ca.crt
        
        # Build Docker images
        echo "Building Docker image with version: \$VERSION"
        docker build -t \$HARBOR_URL/\$HARBOR_PROJECT/$REPOSITORY_NAME:\$VERSION .
        docker build -t \$HARBOR_URL/\$HARBOR_PROJECT/$REPOSITORY_NAME:\${{ github.sha }} .

        # pushã™ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®šï¼ˆPRæ™‚ã¯pushã—ãªã„ï¼‰
        if [ "\$SHOULD_PUSH" == "false" ]; then
          echo "â­ï¸  Skipping push (PR build only)"
          exit 0
        fi

        # /etc/hostsã«harbor.internal.qroksera.comã‚’è¿½åŠ 
        echo "192.168.122.100 harbor.internal.qroksera.com" | sudo tee -a /etc/hosts

        # Harborã«ãƒ­ã‚°ã‚¤ãƒ³
        echo "Logging in to Harbor..."
        docker login \$HARBOR_URL -u "\$HARBOR_USERNAME" -p "\$HARBOR_PASSWORD"

        # Harborã¸push
        echo "Pushing to Harbor..."
        docker push \$HARBOR_URL/\$HARBOR_PROJECT/$REPOSITORY_NAME:\$VERSION
        docker push \$HARBOR_URL/\$HARBOR_PROJECT/$REPOSITORY_NAME:\${{ github.sha }}
        
        echo "âœ… Images pushed successfully to Harbor"
        echo "ğŸ“¦ Pushed tags: \$VERSION, \${{ github.sha }}"
        
    - name: Create and push git tag
      if: steps.version.outputs.should_tag == 'true'
      run: |
        VERSION="\${{ steps.version.outputs.version }}"
        
        # Gitã®è¨­å®š
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ã‚¿ã‚°ã‚’ä½œæˆ
        git tag -a "v\$VERSION" -m "Auto-generated version v\$VERSION"
        
        # ã‚¿ã‚°ã‚’push
        git push origin "v\$VERSION"
        
        echo "âœ… Created and pushed tag: v\$VERSION"
        
    - name: Cleanup
      if: always()
      run: |
        echo "=== Cleanup ==="
        rm -f /tmp/harbor_* /tmp/kubeconfig /tmp/$REPOSITORY_NAME-*.tar
        echo "âœ… Cleanup completed"
WORKFLOW_EOF

# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
log_status "=== ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº† ==="
log_status ""
log_status "âœ… Runnerå®šç¾©ç™»éŒ²:"
log_status "   - $RUNNER_NAME (minRunners=$MIN_RUNNERS, maxRunners=$MAX_RUNNERS)"
log_status "   - ãƒªãƒã‚¸ãƒˆãƒª: https://github.com/$GITHUB_USERNAME/$REPOSITORY_NAME"
log_status ""
log_status "âœ… GitHub Actions workflowä½œæˆ:"
log_status "   - $WORKFLOW_FILE"
log_status ""
log_status "ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
log_status "1. GitHub ãƒªãƒã‚¸ãƒˆãƒªã« Commit & Push"
log_status "   git add $WORKFLOW_FILE"
log_status "   git commit -m \"Add GitHub Actions workflow for $REPOSITORY_NAME\""
log_status "   git push"
log_status "2. ArgoCDåŒæœŸã‚’ç¢ºèªï¼ˆblog-runnerç­‰ãŒSynced/Healthyï¼‰"
log_status "3. GitHub Actionsã§CI/CDãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
log_status ""
log_status "ğŸ‰ $REPOSITORY_NAME ç”¨ã®Runnerç’°å¢ƒãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸï¼"
